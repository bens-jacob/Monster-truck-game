<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Brent's Monster Race</title>
  <style>
    :root{
      --ui-bg: rgba(20,20,30,0.5);
      --ui-fg: #fff;
      --accent: #ffd400;
      --panel: rgba(255,255,255,0.08);
    }
    html, body { height:100%; margin:0; background:#1b1f2a; color:var(--ui-fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; touch-action:none; -webkit-user-select:none; user-select:none; }
    #wrap{ position:fixed; inset:0; display:grid; place-items:center; }
    #view{ display:block; image-rendering:pixelated; image-rendering:crisp-edges; background:#87ceeb; }
    .overlay{ position:fixed; inset:0; pointer-events:none; font-size:14px; }
    .hud{ position:absolute; left:8px; top:8px; pointer-events:none; background:var(--ui-bg); padding:6px 8px; border-radius:12px; display:grid; gap:4px; align-content:start; box-shadow:0 0 0 1px rgba(255,255,255,.18) inset; }
    .row{ display:flex; gap:8px; align-items:center; }
    .label{ opacity:.9; }
    .val{ font-weight:800; color:var(--accent); }
    .bar{ width:180px; height:10px; background:rgba(255,255,255,.15); border-radius:6px; overflow:hidden; }
    .fill{ height:100%; width:0%; background:#ff9800; transition:width .08s linear; }
    .top-right{ position:absolute; right:8px; top:8px; display:flex; gap:8px; }
    .chip{ pointer-events:auto; background:var(--ui-bg); border:1px solid rgba(255,255,255,.2); padding:8px 10px; border-radius:10px; font-weight:800; }
    .controls{ position:absolute; inset:0; pointer-events:none; }
    .btn{ position:absolute; width:96px; height:96px; border-radius:16px; background:rgba(30,30,40,.45); border:2px solid rgba(255,255,255,.35); color:white; font-weight:800; display:grid; place-items:center; pointer-events:auto; -webkit-tap-highlight-color:transparent; touch-action:none; }
    .btn span{ font-size:14px; opacity:.95; }
    #btnBrake{ left:16px; bottom:24px; }
    #btnJump{ right:16px; bottom:24px; }
    #btnBoost{ right:16px; bottom:128px; }
    .start{ position:fixed; inset:0; display:grid; place-content:center; gap:16px; background:linear-gradient(#1a1d28,#10131a); padding:20px; }
    .card{ background:var(--panel); border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:12px; }
    .title{ font-size:28px; font-weight:900; text-align:center; letter-spacing:.5px; }
    .subtitle{ text-align:center; opacity:.9; }
    .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:8px; }
    .truck{ cursor:pointer; border-radius:12px; padding:8px; text-align:center; border:2px solid transparent; background:rgba(0,0,0,.25); }
    .truck.selected{ border-color:var(--accent); background:rgba(255,212,0,.12); }
    .truck canvas{ display:block; margin:0 auto; image-rendering:pixelated; }
    .modes{ display:flex; gap:12px; justify-content:center; align-items:center; margin-top:8px; }
    .start-actions{ display:flex; gap:12px; justify-content:center; margin-top:8px; }
    .btnStart{ padding:10px 18px; border-radius:12px; border:0; font-weight:800; color:#000; background:var(--accent); cursor:pointer; }
    .muted{ opacity:.6; }
    .finish{ position:fixed; inset:0; display:none; place-content:center; text-align:center; gap:12px; background:rgba(0,0,0,.65); padding:20px; }
    .finish .panel{ background:var(--panel); border:1px solid rgba(255,255,255,.25); border-radius:16px; padding:16px 20px; }
    .finish h1{ margin:0 0 8px 0; }
    .finish button{ margin-top:8px; padding:10px 16px; border-radius:12px; border:0; font-weight:800; background:var(--accent); color:#000; cursor:pointer; }
    @media (min-width: 900px){ .btn{ width:108px; height:108px; } #btnBoost{ bottom:140px; } }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="view" width="480" height="270"></canvas>
    <div class="overlay">
      <div class="hud card" id="hud">
        <div class="row"><span class="label">Mode:</span><span class="val" id="hudMode">â€”</span></div>
        <div class="row"><span class="label" id="hudLapLabel">Lap</span>: <span class="val" id="hudLap">0/3</span></div>
        <div class="row"><span class="label">Time:</span><span class="val" id="hudTime">0.0s</span></div>
        <div class="row"><span class="label">Coins:</span><span class="val" id="hudCoins">0</span></div>
        <div class="row" style="align-items:center;">
          <span class="label">Boost</span>
          <div class="bar"><div class="fill" id="boostFill"></div></div>
        </div>
      </div>
      <div class="top-right">
        <button id="btnPause" class="chip">Pause</button>
        <button id="btnMute"  class="chip">Mute</button>
      </div>
      <div class="controls">
        <div class="btn" id="btnBrake"><span>Brake</span></div>
        <div class="btn" id="btnJump"><span>Jump</span></div>
        <div class="btn" id="btnBoost"><span>Boost</span></div>
      </div>
    </div>
    <div class="start" id="startScreen">
      <div class="title">Brent's Monster Race</div>
      <div class="subtitle">Choose your monster ride and mode</div>
      <div class="grid" id="truckGrid"></div>
      <div class="modes card">
        <label><input type="radio" name="mode" value="laps" checked> 3 Laps</label>
        <label><input type="radio" name="mode" value="time"> 60s Time Trial</label>
      </div>
      <div class="start-actions">
        <button class="btnStart" id="btnStart">Start</button>
      </div>
      <div style="text-align:center; font-size:12px; opacity:.8; margin-top:6px;">
        Desktop: A=Brake, Space=Jump, Shift=Boost, P/Esc=Pause, R=Restart, M=Mute
      </div>
    </div>
    <div class="finish" id="finishScreen">
      <div class="panel">
        <h1 id="finishTitle">Great job, Brent!</h1>
        <div id="finishStats"></div>
        <div style="margin-top:6px; font-size:12px; opacity:.85;" id="finishPB"></div>
        <button id="btnRestart">Restart</button>
      </div>
    </div>
  </div>
<script>
'use strict';
const SETTINGS = { SPEED: 58, MAX_SPEED: 95, BRAKE_DECEL: 85, ACCEL: 34, JUMP_POWER: 220, GRAVITY: 560, BOOST_MULTIPLIER: 1.65, BOOST_DRAIN_PER_S: 0.5, BOOST_REFILL_PICKUP: 0.35, LAP_COUNT: 3, TIME_LIMIT_SEC: 60, TRACK_LENGTH: 2200, COIN_COUNT: 26, OBSTACLE_COUNT: 10, BOOSTER_COUNT: 6, CAMERA_LERP: 0.12, SHAKE_MAX: 4, PIXEL_W: 480, PIXEL_H: 270 };
const view=document.getElementById('view'); const ctx=view.getContext('2d'); ctx.imageSmoothingEnabled=false;
const off=document.createElement('canvas'); off.width=SETTINGS.PIXEL_W; off.height=SETTINGS.PIXEL_H; const g=off.getContext('2d'); g.imageSmoothingEnabled=false;
let last=performance.now(); let gameState='menu'; let input={brake:false,jump:false,boost:false}; let mobileHold={brake:false,jump:false,boost:false}; let muted=false; let mode='laps';
const trucks=[ {id:'lambo',name:'Red Monster Lamborghini',color:'#ff3b30',accent:'#ff7b00',wheels:'#171717',flame:true,lights:false,accel:1.0,top:1.0}, {id:'offroad',name:'Black Monster Off-Road',color:'#1f2327',accent:'#ffe066',wheels:'#0d0d0d',flame:false,lights:true,accel:1.05,top:0.95}, {id:'race',name:'Green Monster Race Car',color:'#2ecc71',accent:'#1a9b56',wheels:'#102018',flame:false,lights:false,accel:1.1,top:1.05} ]; let selectedTruck=trucks[0];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v)); const lerp=(a,b,t)=>a+(b-a)*t; const randRange=(a,b)=>a+Math.random()*(b-a); function seededRand(seed){ let s=seed%2147483647; if(s<=0) s+=2147483646; return ()=> (s= s*16807 % 2147483647)/2147483647; } const fmt=t=>Math.max(0,t).toFixed(1)+'s';
const AudioSys=(()=>{ let ac=null; const ensure=()=>{ if(!ac){ const C=window.AudioContext||window.webkitAudioContext; ac=new C(); } return ac; }; function beep(f=700,d=0.12,type='sine',vol=0.2){ if(muted) return; const a=ensure(), o=a.createOscillator(), gg=a.createGain(); o.type=type; o.frequency.value=f; gg.gain.value=vol; o.connect(gg).connect(a.destination); const t=a.currentTime; o.start(t); gg.gain.exponentialRampToValueAtTime(0.0001,t+d); o.stop(t+d); } return { ensure, coin(){ beep(900,0.08,'square',0.18); setTimeout(()=>beep(1200,0.06,'square',0.18),30); }, jump(){ beep(500,0.12,'triangle',0.2); }, land(){ beep(220,0.07,'sine',0.12); }, boost(){ beep(300,0.18,'sawtooth',0.16); }, slow(){ beep(160,0.12,'sine',0.12); } }; })();
function trackHeight(x){ return 150 + Math.sin(x*0.003)*18 + Math.sin(x*0.0016+1.3)*12 + Math.sin(x*0.006+2.1)*6; } function trackSlope(x){ const dx=2; return (trackHeight(x+dx)-trackHeight(x-dx))/(dx*2); }
let world={ lapLen:SETTINGS.TRACK_LENGTH, items:[], obstacles:[], boosters:[], seed:1337 };
function placeWorld(seed){ world.items=[]; world.obstacles=[]; world.boosters=[]; const rnd=seededRand(seed); for(let i=0;i<SETTINGS.COIN_COUNT;i++){ const x=(i+1)*(world.lapLen/(SETTINGS.COIN_COUNT+1))+randRange(-30,30); const y=trackHeight(x)-22-(i%2?8:0); world.items.push({x,y,got:false}); } for(let i=0;i<SETTINGS.OBSTACLE_COUNT;i++){ const x=rnd()*(world.lapLen-200)+120; const y=trackHeight(x); world.obstacles.push({x,y,type:(i%2?'cone':'box'),hit:false}); } for(let i=0;i<SETTINGS.BOOSTER_COUNT;i++){ const x=rnd()*(world.lapLen-200)+100; const y=trackHeight(x)-18; world.boosters.push({x,y,got:false}); } }
let player={ x:50,y:0,vy:0,rot:0,onGround:false,speed:SETTINGS.SPEED,coins:0,lap:1,boost:0.6,boosting:false,time:0,landed:true };
function resetPlayer(){ player.x=50; player.y=trackHeight(player.x)-26; player.vy=0; player.rot=0; player.onGround=true; player.speed=SETTINGS.SPEED; player.coins=0; player.lap=1; player.boost=0.6; player.boosting=false; player.time=0; player.landed=true; camera.x=0; camera.y=0; camera.tx=0; camera.ty=0; shake.time=0; }
let camera={x:0,y:0,tx:0,ty:0}; let shake={time:0,mag:0}; function doShake(m=2,d=120){ shake.time=d; shake.mag=m; }
function clearCanvas(){ const sky=g.createLinearGradient(0,0,0,off.height); sky.addColorStop(0,'#7dc9ff'); sky.addColorStop(1,'#a9dcff'); g.fillStyle=sky; g.fillRect(0,0,off.width,off.height); g.fillStyle='rgba(255,255,255,0.9)'; for(let i=0;i<6;i++){ const cx=((i*120 + camera.x*0.2)%(off.width+200))-100; const cy=40+(i%3)*12; g.fillRect(cx,cy,50,8); g.fillRect(cx+10,cy-6,30,6); g.fillRect(cx+20,cy+6,28,6); } g.fillStyle='#7ac05b'; for(let x=0;x<off.width;x+=2){ const y=Math.sin((x+camera.x*0.12)*0.01)*5+190; g.fillRect(x,y-30,2,30); } }
function drawGround(){ g.fillStyle='#4e8d36'; const startX=camera.x-20, endX=camera.x+off.width+20; for(let sx=Math.floor(startX); sx<endX; sx+=2){ const th=trackHeight(sx); const sy=Math.floor(th-camera.y); g.fillRect(Math.floor(sx-camera.x), sy, 2, off.height-sy); } g.fillStyle='#6a4a2b'; for(let sx=Math.floor(startX); sx<endX; sx+=2){ const th=trackHeight(sx)-6; const sy=Math.floor(th-camera.y); g.fillRect(Math.floor(sx-camera.x), sy, 2, 4); } }
function drawWheel(cx,cy,r,color,hub='#666'){ g.fillStyle=color; g.beginPath(); g.arc(Math.round(cx),Math.round(cy),r,0,Math.PI*2); g.fill(); g.fillStyle='#202020'; for(let a=0;a<Math.PI*2; a+=Math.PI/6){ const tx=cx+Math.cos(a)*(r*0.85); const ty=cy+Math.sin(a)*(r*0.85); g.fillRect(Math.round(tx-1),Math.round(ty-1),2,2); } g.fillStyle=hub; g.beginPath(); g.arc(Math.round(cx),Math.round(cy),r*0.35,0,Math.PI*2); g.fill(); g.fillStyle='#bbb'; for(let a=0;a<Math.PI*2; a+=Math.PI/3){ const tx=cx+Math.cos(a)*(r*0.22); const ty=cy+Math.sin(a)*(r*0.22); g.fillRect(Math.round(tx),Math.round(ty),1,1); } }
function drawFlames(x,y,len=12){ g.fillStyle='#ffa500'; g.fillRect(x-2,y-3,len,4); g.fillStyle='#ffea00'; g.fillRect(x-2,y-2,len*0.6,2); g.fillStyle='#ff5a00'; g.fillRect(x-2,y-1,len*0.9,1); }
function drawTruck(type,x,y,rot){ const R=14, ax=x-22, bx=x+22, wy=y+8; drawWheel(ax,wy,R,type.wheels); drawWheel(bx,wy,R,type.wheels); g.save(); g.translate(x,y); g.rotate(rot*0.2); g.fillStyle='#222'; g.fillRect(-26,-2,52,6); g.fillStyle='rgba(0,0,0,0.25)'; g.fillRect(-28,6,56,3); g.fillStyle=type.color; if(type.id==='lambo'){ g.fillRect(-24,-16,50,12); g.fillStyle='#2f5b79'; g.fillRect(-4,-20,16,6); g.fillStyle='#111'; g.fillRect(-20,-12,44,2); g.fillStyle='#ffcf33'; g.fillRect(-14,-10,12,2); g.fillStyle='#ff7b00'; g.fillRect(2,-10,10,2); if(player.boosting){ drawFlames(x-26,y-8,16); } } else if(type.id==='offroad'){ g.fillRect(-26,-18,34,16); g.fillRect(8,-14,18,12); g.fillStyle='#79a7c7'; g.fillRect(-18,-16,14,7); g.fillStyle='#333'; g.fillRect(-26,-8,10,6); g.fillStyle=type.accent; for(let i=-14;i<=6;i+=10) g.fillRect(i,-22,4,4); } else { g.fillRect(-26,-14,54,12); g.fillStyle=type.accent; g.fillRect(-4,-18,16,6); g.fillStyle=type.color; g.fillRect(18,-14,10,2); g.fillStyle='#0f6f3c'; g.fillRect(-24,-12,20,2); } g.restore(); if(player.boosting){ g.fillStyle='rgba(255,255,255,.5)'; for(let i=0;i<3;i++){ const lx=Math.floor(x-50-i*12+(Math.random()*6)); const ly=Math.floor(y-12+Math.random()*24); g.fillRect(lx,ly,8,1); } } }
function drawCoin(x,y){ g.fillStyle='#ffd400'; g.fillRect(x-3,y-6,6,12); g.fillStyle='#ffea84'; g.fillRect(x-1,y-4,2,8); g.strokeStyle='#7a5200'; g.strokeRect(x-3.5,y-6.5,7,13); }
function drawBooster(x,y){ g.fillStyle='#ff5a00'; g.fillRect(x-6,y-6,12,12); g.fillStyle='#ffee00'; g.fillRect(x-2,y-2,4,4); }
function drawObstacle(o){ if(o.type==='cone'){ g.fillStyle='#ff7b00'; g.fillRect(o.x-6 - camera.x, o.y-10 - camera.y, 12,10); g.fillStyle='#fff'; g.fillRect(o.x-6 - camera.x, o.y-5 - camera.y, 12,2); } else { g.fillStyle='#8b5a2b'; g.fillRect(o.x-8 - camera.x, o.y-12 - camera.y, 16,12); } }
function step(dt){ if(gameState!=='running') return; const truckTop=selectedTruck.top||1, truckAccel=selectedTruck.accel||1; player.speed=lerp(player.speed,SETTINGS.SPEED*truckTop,Math.min(1,dt*0.7)); if(input.brake) player.speed=Math.max(12,player.speed-SETTINGS.BRAKE_DECEL*dt); else player.speed=Math.min(SETTINGS.MAX_SPEED*truckTop,player.speed+SETTINGS.ACCEL*dt*truckAccel); if(input.boost && player.boost>0.01){ player.boosting=true; player.speed=Math.min(SETTINGS.MAX_SPEED*truckTop, player.speed*SETTINGS.BOOST_MULTIPLIER); player.boost=clamp(player.boost-SETTINGS.BOOST_DRAIN_PER_S*dt,0,1); } else player.boosting=false; player.x += player.speed*dt; if(player.x >= world.lapLen*player.lap){ if(mode==='laps'){ if(player.lap >= SETTINGS.LAP_COUNT){ finishRun(); } else { player.lap++; AudioSys.jump(); } } else { player.lap++; AudioSys.jump(); } } player.vy += SETTINGS.GRAVITY*dt; const ground=trackHeight(player.x); if(player.y + player.vy*dt >= ground-26){ if(!player.onGround){ AudioSys.land(); doShake(SETTINGS.SHAKE_MAX,90); } player.y=ground-26; player.vy=0; player.onGround=true; } else { player.y += player.vy*dt; player.onGround=false; } if(input.jump && player.onGround){ player.vy=-SETTINGS.JUMP_POWER; player.onGround=false; AudioSys.jump(); } const slope=trackSlope(player.x); player.rot=lerp(player.rot,slope,0.15); for(const c of world.items){ if(!c.got){ const dx=c.x-player.x, dy=c.y-player.y; if(Math.abs(dx)<14 && Math.abs(dy)<18){ c.got=true; player.coins++; AudioSys.coin(); } } } for(const b of world.boosters){ if(!b.got){ const dx=b.x-player.x, dy=b.y-player.y; if(Math.abs(dx)<16 && Math.abs(dy)<20){ b.got=true; player.boost=clamp(player.boost+SETTINGS.BOOST_REFILL_PICKUP,0,1); AudioSys.boost(); } } } for(const o of world.obstacles){ if(!o.hit){ const dx=o.x-player.x, dy=o.y-player.y; if(Math.abs(dx)<18 && Math.abs(dy)<22){ o.hit=true; player.speed=Math.max(18, player.speed*0.6); doShake(SETTINGS.SHAKE_MAX,140); AudioSys.slow(); } } } player.time+=dt; if(mode==='time' && player.time>=SETTINGS.TIME_LIMIT_SEC) finishRun(); camera.tx=player.x-140; camera.ty=player.y-120; camera.x=lerp(camera.x,camera.tx,SETTINGS.CAMERA_LERP); camera.y=lerp(camera.y,camera.ty,SETTINGS.CAMERA_LERP); if(shake.time>0) shake.time -= dt*1000; }
function render(){ clearCanvas(); drawGround(); for(const c of world.items){ if(!c.got) drawCoin(c.x - camera.x, c.y - camera.y); } for(const b of world.boosters){ if(!b.got) drawBooster(b.x - camera.x, b.y - camera.y); } for(const o of world.obstacles){ if(o.x>camera.x-40 && o.x<camera.x+off.width+40) drawObstacle(o); } drawTruck(selectedTruck, player.x - camera.x, player.y - camera.y, player.rot); const sx=shake.time>0 ? (Math.random()*2-1)*shake.mag : 0; const sy=shake.time>0 ? (Math.random()*2-1)*shake.mag : 0; ctx.imageSmoothingEnabled=false; ctx.clearRect(0,0,view.width,view.height); ctx.drawImage(off, Math.floor(sx), Math.floor(sy)); }
function loop(t){ const dt=Math.min(0.033,(t-last)/1000); last=t; if(gameState==='running') step(dt); render(); document.getElementById('hudTime').textContent=fmt(player.time); document.getElementById('hudCoins').textContent=player.coins; document.getElementById('hudLap').textContent=`${Math.min(player.lap,SETTINGS.LAP_COUNT)}/${SETTINGS.LAP_COUNT}`; document.getElementById('boostFill').style.width=`${Math.floor(player.boost*100)}%`; requestAnimationFrame(loop); }
function resize(){ const w=window.innerWidth, h=window.innerHeight, ar=off.width/off.height; let vw=w, vh=Math.floor(w/ar); if(vh>h){ vh=h; vw=Math.floor(h*ar); } view.width=off.width; view.height=off.height; view.style.width=vw+'px'; view.style.height=vh+'px'; }
window.addEventListener('resize', resize);
function setModeLabels(){ const hudMode=document.getElementById('hudMode'); const lapLabel=document.getElementById('hudLapLabel'); if(mode==='laps'){ hudMode.textContent='3 Laps'; lapLabel.textContent='Lap'; } else { hudMode.textContent='60s Time Trial'; lapLabel.textContent='Lap'; } }
function bindButton(el,onDown,onUp){ const stop=e=>{ e.preventDefault(); e.stopPropagation(); }; el.addEventListener('touchstart', e=>{ stop(e); onDown(); }, {passive:false}); el.addEventListener('touchend', e=>{ stop(e); onUp(); }, {passive:false}); el.addEventListener('mousedown', e=>{ stop(e); onDown(); }); el.addEventListener('mouseup', e=>{ stop(e); onUp(); }); el.addEventListener('mouseleave', e=>{ onUp(); }); }
bindButton(document.getElementById('btnBrake'), ()=>{ mobileHold.brake=true; input.brake=true; }, ()=>{ mobileHold.brake=false; input.brake=false; });
bindButton(document.getElementById('btnJump'), ()=>{ mobileHold.jump=true; input.jump=true; setTimeout(()=>input.jump=false,50); }, ()=>{ mobileHold.jump=false; });
bindButton(document.getElementById('btnBoost'), ()=>{ mobileHold.boost=true; input.boost=true; }, ()=>{ mobileHold.boost=false; input.boost=false; });
document.getElementById('btnPause').addEventListener('click', ()=>{ if(gameState==='running'){ gameState='paused'; document.getElementById('btnPause').textContent='Resume'; } else if(gameState==='paused'){ gameState='running'; document.getElementById('btnPause').textContent='Pause'; AudioSys.ensure(); } });
document.getElementById('btnMute').addEventListener('click', ()=>{ muted=!muted; document.getElementById('btnMute').classList.toggle('muted', muted); if(!muted) AudioSys.ensure(); });
window.addEventListener('keydown', e=>{ if(gameState==='menu') return; if(e.repeat) return; switch(e.code){ case 'KeyA': case 'ArrowLeft': input.brake=true; break; case 'Space': input.jump=true; break; case 'ShiftLeft': case 'ShiftRight': input.boost=true; break; case 'KeyR': restart(); break; case 'KeyP': case 'Escape': if(gameState==='running'){ gameState='paused'; document.getElementById('btnPause').textContent='Resume'; } else if(gameState==='paused'){ gameState='running'; document.getElementById('btnPause').textContent='Pause'; } break; case 'KeyM': muted=!muted; document.getElementById('btnMute').classList.toggle('muted', muted); break; } });
window.addEventListener('keyup', e=>{ switch(e.code){ case 'KeyA': case 'ArrowLeft': input.brake=false; break; case 'Space': input.jump=false; break; case 'ShiftLeft': case 'ShiftRight': input.boost=false; break; } });
function drawTruckThumb(type,size=96){ const c=document.createElement('canvas'); c.width=size; c.height=size; const t=c.getContext('2d'); t.imageSmoothingEnabled=false; t.fillStyle='#22303a'; t.fillRect(0,0,size,size); const x=size/2, y=size/2+8; function wheel(cx,cy,r){ t.fillStyle='#111'; t.beginPath(); t.arc(cx,cy,r,0,Math.PI*2); t.fill(); t.fillStyle='#666'; t.beginPath(); t.arc(cx,cy,r*.35,0,Math.PI*2); t.fill(); } wheel(x-18,y,size*0.14); wheel(x+18,y,size*0.14); t.fillStyle='#222'; t.fillRect(x-22,y-10,44,6); t.fillStyle=type.color; if(type.id==='lambo'){ t.fillRect(x-20,y-22,40,12); t.fillStyle='#2f5b79'; t.fillRect(x-6,y-26,14,6); } else if(type.id==='offroad'){ t.fillRect(x-24,y-20,36,12); t.fillRect(x+8,y-18,14,10); t.fillStyle=type.accent; for(let i=-12;i<=4;i+=8)t.fillRect(x+i,y-24,4,4); } else { t.fillRect(x-22,y-20,44,10); t.fillStyle=type.accent; t.fillRect(x-6,y-24,16,6); t.fillStyle=type.color; t.fillRect(x+14,y-22,8,2); } return c; }
function buildTruckGrid(){ const grid=document.getElementById('truckGrid'); trucks.forEach((t,idx)=>{ const div=document.createElement('div'); div.className='truck'; const thumb=drawTruckThumb(t,96); div.appendChild(thumb); const name=document.createElement('div'); name.textContent=t.name; name.style.marginTop='6px'; name.style.fontSize='12px'; div.appendChild(name); if(idx===0) div.classList.add('selected'); div.addEventListener('click', ()=>{ document.querySelectorAll('.truck').forEach(el=>el.classList.remove('selected')); div.classList.add('selected'); selectedTruck=t; }); grid.appendChild(div); }); }
document.querySelectorAll('input[name="mode"]').forEach(r=> r.addEventListener('change', e=>{ mode = e.target.value==='time' ? 'time' : 'laps'; setModeLabels(); }));
document.getElementById('btnStart').addEventListener('click', ()=>{ document.getElementById('startScreen').style.display='none'; gameState='running'; AudioSys.ensure(); setModeLabels(); });
document.getElementById('btnRestart').addEventListener('click', ()=>{ restart(); });
function restart(){ document.getElementById('finishScreen').style.display='none'; world.seed = Math.floor(Math.random()*100000)|0; placeWorld(world.seed); resetPlayer(); gameState='running'; document.getElementById('btnPause').textContent='Pause'; setModeLabels(); }
function loadPB(id){ try{ const raw=localStorage.getItem('bmr_pb_'+id); return raw?JSON.parse(raw):{bestTimeLaps:null,bestCoinsLaps:0,bestCoinsTime:0}; }catch(_){ return {bestTimeLaps:null,bestCoinsLaps:0,bestCoinsTime:0}; } }
function savePB(id,data){ try{ localStorage.setItem('bmr_pb_'+id, JSON.stringify(data)); }catch(_){} }
function finishRun(){ gameState='finished'; const fin=document.getElementById('finishScreen'); fin.style.display='grid'; document.getElementById('finishTitle').textContent='Great job, Brent!'; document.getElementById('finishStats').innerHTML = `Mode: <b>${mode==='laps'?'3 Laps':'60s Time Trial'}</b><br> Time: <b>${fmt(player.time)}</b> &nbsp; Coins: <b>${player.coins}</b>`; const pb=loadPB(selectedTruck.id); let improved=false; if(mode==='laps'){ if(pb.bestTimeLaps==null || player.time<pb.bestTimeLaps){ pb.bestTimeLaps=player.time; improved=true; } if(player.coins>pb.bestCoinsLaps){ pb.bestCoinsLaps=player.coins; improved=true; } savePB(selectedTruck.id,pb); document.getElementById('finishPB').innerHTML=`Best time: <b>${pb.bestTimeLaps?fmt(pb.bestTimeLaps):'â€”'}</b> &nbsp; Best coins: <b>${pb.bestCoinsLaps}</b>${improved?' <span style="color:#0f0;">(new!)</span>':''}`; } else { if(player.coins>pb.bestCoinsTime){ pb.bestCoinsTime=player.coins; improved=true; } savePB(selectedTruck.id,pb); document.getElementById('finishPB').innerHTML=`Best coins in 60s: <b>${pb.bestCoinsTime}</b>${improved?' <span style="color:#0f0;">(new!)</span>':''}`; } }
function init(){ buildTruckGrid(); placeWorld(world.seed); resetPlayer(); resize(); requestAnimationFrame(loop); }
init();
</script>
</body>
</html>